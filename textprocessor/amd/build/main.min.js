define(["core/ajax","core/notification","aiplacement_textprocessor/selectors","core/drawer_events","core/pubsub","core_message/message_drawer_helper","core/local/aria/focuslock","core/pagehelpers"],function(Ajax,Notification,Selectors,DrawerEvents,PubSub,MessageDrawerHelper,FocusLock,PageHelpers){const AIPTextProcessor=class{userId;contextId;ollamaConfigured;config;currentAction;constructor(userId,contextId,ollamaConfigured,config={}){this.userId=userId;this.contextId=contextId;this.ollamaConfigured=ollamaConfigured;this.config=config;this.currentAction='to_html';this.aiDrawerElement=document.querySelector(Selectors.ELEMENTS.AIDRAWER);this.aiDrawerBodyElement=document.querySelector(Selectors.ELEMENTS.AIDRAWER_BODY);this.pageElement=document.querySelector(Selectors.ELEMENTS.PAGE);this.jumpToElement=document.querySelector(Selectors.ELEMENTS.JUMPTO);this.actionElement=document.querySelector(Selectors.ELEMENTS.ACTION);this.container=document.querySelector(Selectors.ELEMENTS.TEXTPROCESSOR_CONTAINER);this.input=this.container?.querySelector(Selectors.ELEMENTS.TEXTPROCESSOR_INPUT);this.output=this.container?.querySelector(Selectors.ELEMENTS.TEXTPROCESSOR_OUTPUT);this.preview=this.container?.querySelector(Selectors.ELEMENTS.TEXTPROCESSOR_PREVIEW);this.processBtn=this.container?.querySelector(Selectors.ELEMENTS.TEXTPROCESSOR_PROCESS_BTN);this.copyBtn=this.container?.querySelector(Selectors.ELEMENTS.TEXTPROCESSOR_COPY_BTN);this.insertBtn=this.container?.querySelector(Selectors.ELEMENTS.TEXTPROCESSOR_INSERT_BTN);this.actionBtns=this.container?.querySelectorAll(Selectors.ELEMENTS.TEXTPROCESSOR_ACTION_BTN);this.isDrawerFocusLocked=false;this.registerEventListeners();}registerEventListeners(){document.addEventListener('click',(e)=>{const textprocessorAction=e.target.closest(Selectors.ACTIONS.TEXTPROCESSOR_OPEN);if(textprocessorAction){e.preventDefault();this.openAIDrawer();}const closeAiDrawer=e.target.closest(Selectors.ELEMENTS.AIDRAWER_CLOSE);if(closeAiDrawer){e.preventDefault();this.closeAIDrawer();}});if(this.processBtn){this.processBtn.addEventListener('click',()=>this.process());}if(this.copyBtn){this.copyBtn.addEventListener('click',()=>this.copyToClipboard());}if(this.insertBtn){this.insertBtn.addEventListener('click',()=>this.insertToEditor());}if(this.actionBtns&&this.actionBtns.length){this.actionBtns.forEach((btn)=>{btn.addEventListener('click',(e)=>{const action=e.target.dataset.action||e.target.closest('[data-action]')?.dataset.action;if(action){this.setAction(action);this.process();}});});}document.addEventListener('keydown',e=>{if(this.isAIDrawerOpen()&&e.key==='Escape'){this.closeAIDrawer();}});PubSub.subscribe(DrawerEvents.DRAWER_SHOWN,()=>{if(this.isAIDrawerOpen()){this.closeAIDrawer();}});if(this.jumpToElement){this.jumpToElement.addEventListener('focus',()=>{const closeBtn=this.aiDrawerElement?.querySelector(Selectors.ELEMENTS.AIDRAWER_CLOSE);if(closeBtn){closeBtn.focus();}});}if(this.aiDrawerElement&&this.actionElement){this.aiDrawerElement.addEventListener('focus',()=>{this.actionElement.focus();});}if(this.actionElement){this.actionElement.addEventListener('blur',()=>{this.actionElement.classList.remove('active');});}}setAction(action){this.currentAction=action;if(this.actionBtns&&this.actionBtns.length){this.actionBtns.forEach((btn)=>{const btnAction=btn.dataset.action;if(btnAction===action){btn.classList.add('active','btn-primary');btn.classList.remove('btn-outline-secondary');}else{btn.classList.remove('active','btn-primary');btn.classList.add('btn-outline-secondary');}});}}isAIDrawerOpen(){return this.aiDrawerElement?.classList.contains('show');}openAIDrawer(){if(!this.aiDrawerElement){return;}MessageDrawerHelper.hide();this.aiDrawerElement.classList.add('show');this.aiDrawerElement.setAttribute('tabindex',0);this.aiDrawerBodyElement?.setAttribute('aria-live','polite');if(this.pageElement&&!this.pageElement.classList.contains('show-drawer-right')){this.addPadding();}if(this.jumpToElement){this.jumpToElement.setAttribute('tabindex',0);this.jumpToElement.focus();}if(PageHelpers.isSmall()){FocusLock.trapFocus(this.aiDrawerElement);this.aiDrawerElement.setAttribute('aria-modal','true');this.aiDrawerElement.setAttribute('role','dialog');this.isDrawerFocusLocked=true;}}closeAIDrawer(){if(!this.aiDrawerElement){return;}if(this.isDrawerFocusLocked){FocusLock.untrapFocus();this.aiDrawerElement.removeAttribute('aria-modal');this.aiDrawerElement.setAttribute('role','region');}this.aiDrawerElement.classList.remove('show');this.aiDrawerElement.setAttribute('tabindex',-1);if(this.aiDrawerBodyElement){this.aiDrawerBodyElement.removeAttribute('aria-live');}if(this.pageElement&&this.pageElement.classList.contains('show-drawer-right')){this.removePadding();}if(this.jumpToElement){this.jumpToElement.setAttribute('tabindex',-1);}if(this.actionElement){this.actionElement.classList.add('active');this.actionElement.focus();}}toggleAIDrawer(){if(this.isAIDrawerOpen()){this.closeAIDrawer();}else{this.openAIDrawer();}}addPadding(){if(this.pageElement&&this.aiDrawerBodyElement){this.pageElement.classList.add('show-drawer-right');this.aiDrawerBodyElement.dataset.removepadding='1';}}removePadding(){if(this.pageElement&&this.aiDrawerBodyElement){this.pageElement.classList.remove('show-drawer-right');this.aiDrawerBodyElement.dataset.removepadding='0';}}async process(){if(!this.ollamaConfigured){Notification.alert('Ollama not configured','Please configure Ollama in plugin settings to process text.');return;}const text=this.input?.value?.trim();if(!text){Notification.alert('Error','Please enter text to process');return;}this.setLoading(true);try{const response=await Ajax.call([{methodname:'aiplacement_textprocessor_process',args:{text:text,action:this.currentAction,contextid:this.contextId}}])[0];if(response.success){if(this.output){this.output.value=response.html;}if(this.preview){this.preview.innerHTML=response.html;}}else{throw new Error(response.message||'Processing error');}}catch(error){Notification.exception(error);if(this.output){this.output.value='Error: '+error.message;}Notification.alert('Error',error.message);}finally{this.setLoading(false);}}copyToClipboard(){const html=this.output?.value;if(!html){return;}navigator.clipboard.writeText(html).then(()=>{const originalText=this.copyBtn?.textContent;if(this.copyBtn){this.copyBtn.textContent='✓ Copied!';}setTimeout(()=>{if(this.copyBtn&&originalText){this.copyBtn.textContent=originalText;}},2000);}).catch(()=>{Notification.alert('Error','Failed to copy');});}insertToEditor(){const html=this.output?.value;if(!html){return;}if(this.config.editor){this.config.editor.insertContent(html);}else if(this.config.editorId){const textarea=document.getElementById(this.config.editorId);if(textarea){const start=textarea.selectionStart;const end=textarea.selectionEnd;textarea.value=textarea.value.substring(0,start)+html+textarea.value.substring(end);}}}setLoading(loading){if(!this.processBtn){return;}if(loading){this.processBtn.disabled=true;this.processBtn.innerHTML='⏳ Processing...';}else{this.processBtn.disabled=!this.ollamaConfigured;this.processBtn.innerHTML='✨ Process';}}};return AIPTextProcessor;});