define("aiplacement_textprocessor/editor_button",["core/ajax","core/notification","core/templates","core/modal_factory","core/modal_events","core/str"],function(Ajax,Notification,Templates,ModalFactory,ModalEvents,Str){let currentEditor=null;let contextId=null;let modal=null;function init(ctxid){contextId=ctxid;setupEditorIntegration()}function setupEditorIntegration(){if(typeof tinymce!=="undefined"){registerTinyMCEPlugin()}if(document.querySelector(".editor_atto_toolbar")){setupAttoButtons()}const observer=new MutationObserver(function(mutations){mutations.forEach(function(mutation){if(mutation.target.classList&&mutation.target.classList.contains("editor_atto_toolbar")){setupAttoButtons()}if(mutation.target.id&&mutation.target.id.indexOf("tinymce")!==-1){registerTinyMCEPlugin()}})});observer.observe(document.body,{childList:true,subtree:true});if(typeof window.M!=="undefined"&&window.M.util&&window.M.util.js_pending){window.M.util.js_pending("aiplacement_textprocessor_init");setTimeout(function(){registerTinyMCEPlugin();setupAttoButtons();if(window.M.util.js_complete){window.M.util.js_complete("aiplacement_textprocessor_init")}},500)}}function registerTinyMCEPlugin(){if(typeof tinymce==="undefined"){return}if(tinymce.PluginManager.lookup["aiplacement_textprocessor"]){return}tinymce.PluginManager.add("aiplacement_textprocessor",function(editor){editor.ui.registry.addButton("aiplacement_textprocessor",{icon:"format",tooltip:"AI TextProcessor",onAction:function(){currentEditor=editor;openDialog()}});editor.ui.registry.addMenuItem("aiplacement_textprocessor",{icon:"format",text:"AI TextProcessor",onAction:function(){currentEditor=editor;openDialog()}})});if(tinymce.EditorManager&&tinymce.EditorManager.editors){tinymce.EditorManager.editors.forEach(function(editor){if(editor.ui.registry&&editor.ui.registry.getAll&&!editor.ui.registry.getAll().buttons.aiplacement_textprocessor){editor.ui.registry.addButton("aiplacement_textprocessor",{icon:"format",tooltip:"AI TextProcessor",onAction:function(){currentEditor=editor;openDialog()}})}})}}function setupAttoButtons(){const toolbars=document.querySelectorAll(".editor_atto_toolbar");toolbars.forEach(function(toolbar){if(toolbar.querySelector(".atto_textprocessor_button")){return}let buttonGroup=toolbar.querySelector(".textprocessor_group");if(!buttonGroup){buttonGroup=document.createElement("div");buttonGroup.className="atto_group textprocessor_group";toolbar.appendChild(buttonGroup)}const button=document.createElement("button");button.className="atto_textprocessor_button atto_button";button.title="AI TextProcessor";button.innerHTML='<span class="icon" style="font-size: 16px;">âœ¨</span>';button.type="button";button.addEventListener("click",function(e){e.preventDefault();const editorId=toolbar.id.replace("editor_atto_toolbar_","");const textarea=document.getElementById(editorId);currentEditor={type:"atto",textarea:textarea,editorId:editorId,insertContent:function(html){if(window.Y&&window.Y.M&&window.Y.M.editor_atto){const editorInstance=window.Y.M.editor_atto.get_instance(editorId);if(editorInstance){editorInstance.insertContentAtFocusPoint(html);return}}if(textarea){const start=textarea.selectionStart;const end=textarea.selectionEnd;textarea.value=textarea.value.substring(0,start)+html+textarea.value.substring(end);textarea.selectionStart=textarea.selectionEnd=start+html.length}}};openDialog()});buttonGroup.appendChild(button)})}async function openDialog(){try{const strings=await Str.get_strings([{key:"pluginname",component:"aiplacement_textprocessor"},{key:"process",component:"aiplacement_textprocessor"},{key:"cancel",component:"core"},{key:"insert",component:"aiplacement_textprocessor"}]);modal=await ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:await getModalBody(),buttons:{save:strings[3],cancel:strings[2]}});modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault();processAndInsert()});modal.getRoot().on("change",'[name="template"]',function(e){const customPromptField=modal.getRoot().find('[name="customprompt"]');if(e.target.value==="custom"){customPromptField.closest(".form-group").show()}else{customPromptField.closest(".form-group").hide()}});modal.show()}catch(error){Notification.exception(error)}}async function getModalBody(){const context={contextid:contextId,templates:[{value:"document_to_html",name:"ðŸ“„ Document to HTML",selected:true},{value:"structure_headings",name:"ðŸ“‘ Structure Headings"},{value:"definitions_table",name:"ðŸ“Š Definitions Table"},{value:"image_centering",name:"ðŸ–¼ï¸ Image Centering"},{value:"custom",name:"âœï¸ Custom"}]};return Templates.render("aiplacement_textprocessor/editor_dialog",context)}async function processAndInsert(){const root=modal.getRoot();const template=root.find('[name="template"]').val();const customprompt=root.find('[name="customprompt"]').val();const fileInput=root.find('[name="file"]')[0];const textInput=root.find('[name="text"]').val();let content="";let filename="";if(fileInput&&fileInput.files&&fileInput.files.length>0){const file=fileInput.files[0];filename=file.name;content=await readFileAsBase64(file)}else{content=textInput}if(!content||!content.trim()){Notification.alert("Error","Please enter text or select a file");return}const loadingEl=root.find(".textprocessor-loading");if(loadingEl.length){loadingEl.show()}const saveBtn=root.find('[data-action="save"]');if(saveBtn.length){saveBtn.prop("disabled",true)}try{const response=await Ajax.call([{methodname:"aiplacement_textprocessor_process",args:{contextid:contextId,content:content,template:template,filename:filename,customprompt:customprompt}}])[0];if(response.success&&response.html){insertIntoEditor(response.html);modal.hide()}else{Notification.alert("Error",response.message||"Processing failed")}}catch(error){Notification.exception(error)}finally{if(saveBtn.length){saveBtn.prop("disabled",false)}if(loadingEl.length){loadingEl.hide()}}}function readFileAsBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=function(e){const base64=e.target.result.split(",")[1];resolve(base64)};reader.onerror=reject;reader.readAsDataURL(file)})}function insertIntoEditor(html){if(!currentEditor){navigator.clipboard.writeText(html).then(function(){Notification.alert("Copied","HTML copied to clipboard. Paste it in the editor.")});return}if(currentEditor.insertContent){currentEditor.insertContent(html);return}if(typeof currentEditor.insertContentAtFocusPoint==="function"){currentEditor.insertContentAtFocusPoint(html);return}if(currentEditor.id){const textarea=document.getElementById(currentEditor.id);if(textarea){const start=textarea.selectionStart;const end=textarea.selectionEnd;textarea.value=textarea.value.substring(0,start)+html+textarea.value.substring(end);textarea.selectionStart=textarea.selectionEnd=start+html.length}}}return{initForTinyMCE:function(editor,contextid){currentEditor=editor;contextId=contextid;editor.ui.registry.addButton("aiplacement_textprocessor",{icon:"format",tooltip:"AI TextProcessor",onAction:function(){openDialog()}})},initForAtto:function(editor,contextid){currentEditor=editor;contextId=contextid},openDialog:function(editor,contextid){currentEditor=editor;contextId=contextid;openDialog()},processText:async function(contextid,content,template,filename,customprompt){return Ajax.call([{methodname:"aiplacement_textprocessor_process",args:{contextid:contextid,content:content,template:template,filename:filename||"",customprompt:customprompt||""}}])[0]},init:function(contextid){init(contextid)}}});