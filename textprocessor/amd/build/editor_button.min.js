define("aiplacement_textprocessor/editor_button",["core/modal_save_cancel","core/modal_events","core/ajax","core/notification","core/templates","core/str"],(function(a,b,c,d,e,f){let g=null,h=null,i=null,j=null;function k(a){console.log("TextProcessor: init() called with contextId:",a),i=a,"undefined"!=typeof M&&M.util&&M.util.js_pending&&M.util.js_pending("aiplacement_textprocessor_init"),l(),m(),"undefined"!=typeof M&&M.util&&M.util.js_complete&&setTimeout(function(){M.util.js_complete("aiplacement_textprocessor_init")},500)}function l(){if("undefined"!=typeof tinymce&&tinymce.EditorManager)return n(),void o();let a=0,b=50,c=setInterval(function(){a++,"undefined"!=typeof tinymce&&tinymce.EditorManager?(clearInterval(c),n(),o()):a>=b&&clearInterval(c)},200)}function o(){"undefined"!=typeof tinymce&&tinymce.EditorManager&&tinymce.EditorManager.on("AddEditor",function(a){setTimeout(function(){p(a.editor)},100)})}function n(){if("undefined"==typeof tinymce)return;let a=null;if(tinymce.EditorManager&&tinymce.EditorManager.editors?a=tinymce.EditorManager.editors:tinymce.editors&&(a=tinymce.editors),!a)return;const b=Array.isArray(a)?a:Object.values(a);b.length&&b.forEach(function(a){p(a)})}function p(b){if(!b||!b.ui||!b.ui.registry)return;const c=b.ui.registry.getAll().buttons||{};c.ai_textprocessor||(b.ui.registry.addButton("ai_textprocessor",{icon:"format",tooltip:"AI TextProcessor",onAction:function(){g=b,h="tinymce",q()}}),b.ui.registry.addMenuItem("ai_textprocessor",{icon:"format",text:"AI TextProcessor",onAction:function(){g=b,h="tinymce",q()}}))}function m(){document.querySelector(".editor_atto_toolbar")&&r();const a=new MutationObserver(function(a){a.forEach(function(a){a.addedNodes.forEach(function(a){a.classList&&a.classList.contains("editor_atto_toolbar")?s(a):a.querySelectorAll&&a.querySelectorAll(".editor_atto_toolbar").forEach(function(a){s(a)})})})});a.observe(document.body,{childList:!0,subtree:!0}),setTimeout(function(){r()},1e3)}function r(){document.querySelectorAll(".editor_atto_toolbar").forEach(function(a){s(a)})}function s(a){if(a.querySelector(".atto_ai_textprocessor_button"))return;let b=a.querySelector(".atto_group.ai_tools");b||((b=document.createElement("div")).className="atto_group ai_tools",a.appendChild(b));const c=document.createElement("button");c.className="atto_button atto_ai_textprocessor_button",c.title="AI TextProcessor",c.innerHTML='<span class="icon" aria-hidden="true">âœ¨</span>',c.type="button",c.addEventListener("click",function(b){b.preventDefault(),b.stopPropagation();const c=a.id||"",d=c.replace("editor_atto_toolbar_",""),e=document.getElementById(d);let f=i;if(!f&&e){const a=e.closest("form");if(a){const b=a.querySelector('input[name="contextid"]');b&&(f=parseInt(b.value,10))}!f&&"undefined"!=typeof M&&M.cfg&&M.cfg.contextid&&(f=M.cfg.contextid)}f||(f=1),i=f,g={type:"atto",textarea:e,editorId:d,toolbar:a},h="atto",q()}),b.appendChild(c)}async function q(){try{const h=await f.get_strings([{key:"pluginname",component:"aiplacement_textprocessor"},{key:"process",component:"aiplacement_textprocessor"},{key:"insert",component:"aiplacement_textprocessor"}]),k=await e.render("aiplacement_textprocessor/editor_dialog",{contextid:i});j=await a.create({title:h[0],body:k,buttons:{save:h[2]},large:!0}),j.getRoot().on(b.save,function(a){a.preventDefault(),t()}),j.show()}catch(a){d.exception(a)}}async function t(){const a=j.getRoot(),b=a.find('[name="file"]')[0],e=a.find('[name="text"]').val();let f="",h="";if(b&&b.files&&b.files.length>0){const a=b.files[0];h=a.name,f=await u(a)}else f=e;if(console.log("TextProcessor: Content length:",f?f.length:0),!f||!f.trim())return void d.alert("Error","Please enter text or select a file");const k=a.find(".textprocessor-loading"),l=a.find('[data-action="save"]'),m=l.text();k.removeClass("hidden"),l.prop("disabled",!0).text("Processing...");try{console.log("TextProcessor: Calling API...");const b=await c.call([{methodname:"aiplacement_textprocessor_process",args:{contextid:i,content:f,filename:h}}])[0];console.log("TextProcessor: API response:",b),b.success&&b.html?(console.log("TextProcessor: Inserting HTML..."),v(b.html),j.hide(),console.log("TextProcessor: Done!")):(console.error("TextProcessor: Failed:",b.message),d.alert("Error",b.message||"Processing failed"))}catch(a){console.error("TextProcessor: API error:",a),d.exception(a)}finally{l.prop("disabled",!1).text(m),k.addClass("hidden")}}function u(a){return new Promise((b,c)=>{const d=new FileReader;d.onload=function(a){const c=a.target.result.split(",")[1];b(c)},d.onerror=c,d.readAsDataURL(a)})}function v(a){if(console.log("TextProcessor: insertIntoEditor called"),console.log("TextProcessor: editorType:",h),console.log("TextProcessor: currentEditor:",g),console.log("TextProcessor: html preview:",a?a.substring(0,200)+"...":"empty"),!a)return void console.log("TextProcessor: No HTML to insert");if("tinymce"===h&&g&&"function"==typeof g.insertContent)return console.log("TextProcessor: Using TinyMCE"),void g.insertContent(a);if("atto"===h&&g){console.log("TextProcessor: Processing Atto");const b=g.editorId;console.log("TextProcessor: editorId:",b);let c=document.querySelector('[contenteditable="true"][id="'+b+'editable"]');if(console.log("TextProcessor: contenteditable by editorId:",c),!c&&(c=document.querySelector('[contenteditable="true"][id$="editable"]'),console.log("TextProcessor: contenteditable any editable:",c)),!c){const a=document.querySelector(".editor_atto_content");a&&(c=a.querySelector('[contenteditable="true"]'))}if(console.log("TextProcessor: final contenteditable:",c),c)return console.log("TextProcessor: Inserting via execCommand"),c.focus(),void document.execCommand("insertHTML",!1,a);const d=document.getElementById(b);if(d&&"TEXTAREA"===d.tagName)return console.log("TextProcessor: Using textarea"),d.value=(d.value||"")+a,void d.dispatchEvent(new Event("change",{bubbles:!0}));console.log("TextProcessor: No Atto method found")}console.log("TextProcessor: Using clipboard fallback"),navigator.clipboard.writeText(a).then(function(){d.alert("Copied","HTML copied to clipboard. Paste it in the editor.")})}return{init:function(a){k(a)},openDialogExternal:function(a,b){g=a,i=b,h=a&&"function"==typeof a.insertContent?"tinymce":"atto",q()}}}));