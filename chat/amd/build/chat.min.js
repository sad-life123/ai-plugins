define(["core/ajax","core/notification","aiplacement_chat/selectors","core/drawer_events","core/pubsub","core_message/message_drawer_helper","core/local/aria/focuslock","core/pagehelpers"],function(Ajax,Notification,Selectors,DrawerEvents,PubSub,MessageDrawerHelper,FocusLock,PageHelpers){const AIPChat=class{userId;contextId;courseId;ollamaConfigured;config;constructor(userId,contextId,courseId,ollamaConfigured,config={}){this.userId=userId;this.contextId=contextId;this.courseId=courseId;this.ollamaConfigured=ollamaConfigured;this.config=config;this.messages=[];this.aiDrawerElement=document.querySelector(Selectors.ELEMENTS.AIDRAWER);this.aiDrawerBodyElement=document.querySelector(Selectors.ELEMENTS.AIDRAWER_BODY);this.pageElement=document.querySelector(Selectors.ELEMENTS.PAGE);this.jumpToElement=document.querySelector(Selectors.ELEMENTS.JUMPTO);this.actionElement=document.querySelector(Selectors.ELEMENTS.ACTION);this.chatContainer=document.querySelector(Selectors.ELEMENTS.CHAT_CONTAINER);this.messagesContainer=this.chatContainer?.querySelector(Selectors.ELEMENTS.CHAT_MESSAGES);this.input=this.chatContainer?.querySelector(Selectors.ELEMENTS.CHAT_INPUT);this.sendBtn=this.chatContainer?.querySelector(Selectors.ELEMENTS.CHAT_SEND);this.typingIndicator=this.chatContainer?.querySelector(Selectors.ELEMENTS.CHAT_TYPING);this.clearBtn=this.chatContainer?.querySelector(Selectors.ELEMENTS.CHAT_CLEAR);this.isDrawerFocusLocked=false;this.registerEventListeners();if(this.ollamaConfigured){this.addMessage('assistant','üëã Hello! I am the AI assistant for this course. Ask me about the materials, assignments, or course structure.');}}registerEventListeners(){document.addEventListener('click',(e)=>{const chatAction=e.target.closest(Selectors.ACTIONS.CHAT_OPEN);if(chatAction){e.preventDefault();this.openAIDrawer();}const closeAiDrawer=e.target.closest(Selectors.ELEMENTS.AIDRAWER_CLOSE);if(closeAiDrawer){e.preventDefault();this.closeAIDrawer();}});if(this.sendBtn){this.sendBtn.addEventListener('click',()=>this.sendMessage());}if(this.input){this.input.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.ctrlKey&&!e.shiftKey){e.preventDefault();this.sendMessage();}});this.input.addEventListener('input',()=>{if(this.sendBtn){this.sendBtn.disabled=this.input.value.trim().length===0||!this.ollamaConfigured;}});}if(this.clearBtn){this.clearBtn.addEventListener('click',()=>this.clearHistory());}document.addEventListener('keydown',e=>{if(this.isAIDrawerOpen()&&e.key==='Escape'){this.closeAIDrawer();}});PubSub.subscribe(DrawerEvents.DRAWER_SHOWN,()=>{if(this.isAIDrawerOpen()){this.closeAIDrawer();}});if(this.jumpToElement){this.jumpToElement.addEventListener('focus',()=>{const closeBtn=this.aiDrawerElement?.querySelector(Selectors.ELEMENTS.AIDRAWER_CLOSE);if(closeBtn){closeBtn.focus();}});}if(this.aiDrawerElement&&this.actionElement){this.aiDrawerElement.addEventListener('focus',()=>{this.actionElement.focus();});}if(this.actionElement){this.actionElement.addEventListener('blur',()=>{this.actionElement.classList.remove('active');});}}isAIDrawerOpen(){return this.aiDrawerElement?.classList.contains('show');}openAIDrawer(){if(!this.aiDrawerElement){return;}MessageDrawerHelper.hide();this.aiDrawerElement.classList.add('show');this.aiDrawerElement.setAttribute('tabindex',0);this.aiDrawerBodyElement?.setAttribute('aria-live','polite');if(this.pageElement&&!this.pageElement.classList.contains('show-drawer-right')){this.addPadding();}if(this.jumpToElement){this.jumpToElement.setAttribute('tabindex',0);this.jumpToElement.focus();}if(PageHelpers.isSmall()){FocusLock.trapFocus(this.aiDrawerElement);this.aiDrawerElement.setAttribute('aria-modal','true');this.aiDrawerElement.setAttribute('role','dialog');this.isDrawerFocusLocked=true;}}closeAIDrawer(){if(!this.aiDrawerElement){return;}if(this.isDrawerFocusLocked){FocusLock.untrapFocus();this.aiDrawerElement.removeAttribute('aria-modal');this.aiDrawerElement.setAttribute('role','region');}this.aiDrawerElement.classList.remove('show');this.aiDrawerElement.setAttribute('tabindex',-1);if(this.aiDrawerBodyElement){this.aiDrawerBodyElement.removeAttribute('aria-live');}if(this.pageElement&&this.pageElement.classList.contains('show-drawer-right')){this.removePadding();}if(this.jumpToElement){this.jumpToElement.setAttribute('tabindex',-1);}if(this.actionElement){this.actionElement.classList.add('active');this.actionElement.focus();}}toggleAIDrawer(){if(this.isAIDrawerOpen()){this.closeAIDrawer();}else{this.openAIDrawer();}}addPadding(){if(this.pageElement&&this.aiDrawerBodyElement){this.pageElement.classList.add('show-drawer-right');this.aiDrawerBodyElement.dataset.removepadding='1';}}removePadding(){if(this.pageElement&&this.aiDrawerBodyElement){this.pageElement.classList.remove('show-drawer-right');this.aiDrawerBodyElement.dataset.removepadding='0';}}async sendMessage(){if(!this.ollamaConfigured){Notification.alert('Ollama not configured','Please configure Ollama in plugin settings to use chat.');return;}const text=this.input?.value?.trim();if(!text){return;}this.addMessage('user',text);if(this.input){this.input.value='';}if(this.sendBtn){this.sendBtn.disabled=true;}this.setTyping(true);try{const response=await Ajax.call([{methodname:'aiplacement_chat_send_message',args:{message:text,courseid:this.courseId,history:JSON.stringify(this.messages.slice(-10))}}])[0];this.setTyping(false);if(response.success){this.addMessage('assistant',response.message);}else{this.addMessage('system',response.message||'Error');Notification.alert('Error',response.message||'Failed to get response from AI');}}catch(error){this.setTyping(false);Notification.exception(error);this.addMessage('system','Connection error: '+error.message);}}addMessage(role,content){if(!this.messagesContainer){return;}const messageDiv=document.createElement('div');messageDiv.className=`coursechat-message ${role}`;const time=new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});let avatar='ü§ñ';if(role==='user')avatar='üë§';if(role==='system')avatar='‚öôÔ∏è';messageDiv.innerHTML=`<div class="message-avatar">${avatar}</div><div class="message-content"><div>${this.formatMessage(content)}</div><div class="message-time">${time}</div></div>`;this.messagesContainer.appendChild(messageDiv);this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight;this.messages.push({role,content,time});}formatMessage(text){text=text.replace(/\n/g,'<br>');text=text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');text=text.replace(/\*(.*?)\*/g,'<em>$1</em>');text=text.replace(/`(.*?)`/g,'<code>$1</code>');return text;}setTyping(typing){if(this.typingIndicator){this.typingIndicator.style.display=typing?'flex':'none';}if(typing&&this.messagesContainer){setTimeout(()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight;},100);}}clearHistory(){Ajax.call([{methodname:'aiplacement_chat_clear_history',args:{courseid:this.courseId}}]);if(this.messagesContainer){this.messagesContainer.innerHTML='';}this.messages=[];this.addMessage('assistant','üëã Hello! I am the AI assistant for this course. Ask me about the materials, assignments, or course structure.');}};return AIPChat;});