define(["core/ajax","core/str","core/notification","core/templates","aiplacement_quizgen/selectors","core/drawer_events","core/pubsub","core_message/message_drawer_helper","core/local/aria/focuslock","core/pagehelpers"],function(Ajax,Str,Notification,Templates,Selectors,DrawerEvents,PubSub,MessageDrawerHelper,FocusLock,PageHelpers){const AIPQuizGen=class{userId;contextId;courseId;ollamaConfigured;config;questions;selectedQuestions;constructor(userId,contextId,courseId,ollamaConfigured,config={}){this.userId=userId;this.contextId=contextId;this.courseId=courseId;this.ollamaConfigured=ollamaConfigured;this.config=config;this.questions=[];this.selectedQuestions=new Set();this.aiDrawerElement=document.querySelector(Selectors.ELEMENTS.AIDRAWER);this.aiDrawerBodyElement=document.querySelector(Selectors.ELEMENTS.AIDRAWER_BODY);this.pageElement=document.querySelector(Selectors.ELEMENTS.PAGE);this.jumpToElement=document.querySelector(Selectors.ELEMENTS.JUMPTO);this.actionElement=document.querySelector(Selectors.ELEMENTS.ACTION);this.container=document.querySelector(Selectors.ELEMENTS.QUIZGEN_CONTAINER);this.textarea=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_TEXTAREA);this.countSelect=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_COUNT_SELECT);this.typeSelect=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_TYPE_SELECT);this.difficultySelect=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_DIFFICULTY_SELECT);this.languageSelect=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_LANGUAGE_SELECT);this.generateBtn=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_GENERATE_BTN);this.progressBar=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_PROGRESS);this.questionsGrid=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_QUESTIONS_GRID);this.saveAllBtn=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_SAVE_ALL_BTN);this.charCounter=this.container?.querySelector(Selectors.ELEMENTS.QUIZGEN_CHAR_COUNTER);this.isDrawerFocusLocked=false;this.registerEventListeners();}registerEventListeners(){document.addEventListener('click',(e)=>{const quizgenAction=e.target.closest(Selectors.ACTIONS.QUIZGEN_OPEN);if(quizgenAction){e.preventDefault();this.openAIDrawer();}const closeAiDrawer=e.target.closest(Selectors.ELEMENTS.AIDRAWER_CLOSE);if(closeAiDrawer){e.preventDefault();this.closeAIDrawer();}});if(this.generateBtn){this.generateBtn.addEventListener('click',()=>this.generate());}if(this.saveAllBtn){this.saveAllBtn.addEventListener('click',()=>this.saveAll());}if(this.textarea){this.textarea.addEventListener('keydown',(e)=>{if(e.ctrlKey&&e.key==='Enter'){e.preventDefault();this.generate();}});this.textarea.addEventListener('input',()=>this.updateCharCount());}document.addEventListener('keydown',e=>{if(this.isAIDrawerOpen()&&e.key==='Escape'){this.closeAIDrawer();}});PubSub.subscribe(DrawerEvents.DRAWER_SHOWN,()=>{if(this.isAIDrawerOpen()){this.closeAIDrawer();}});if(this.jumpToElement){this.jumpToElement.addEventListener('focus',()=>{const closeBtn=this.aiDrawerElement?.querySelector(Selectors.ELEMENTS.AIDRAWER_CLOSE);if(closeBtn){closeBtn.focus();}});}if(this.aiDrawerElement&&this.actionElement){this.aiDrawerElement.addEventListener('focus',()=>{this.actionElement.focus();});}if(this.actionElement){this.actionElement.addEventListener('blur',()=>{this.actionElement.classList.remove('active');});}}isAIDrawerOpen(){return this.aiDrawerElement?.classList.contains('show');}openAIDrawer(){if(!this.aiDrawerElement){return;}MessageDrawerHelper.hide();this.aiDrawerElement.classList.add('show');this.aiDrawerElement.setAttribute('tabindex',0);this.aiDrawerBodyElement?.setAttribute('aria-live','polite');if(this.pageElement&&!this.pageElement.classList.contains('show-drawer-right')){this.addPadding();}if(this.jumpToElement){this.jumpToElement.setAttribute('tabindex',0);this.jumpToElement.focus();}if(PageHelpers.isSmall()){FocusLock.trapFocus(this.aiDrawerElement);this.aiDrawerElement.setAttribute('aria-modal','true');this.aiDrawerElement.setAttribute('role','dialog');this.isDrawerFocusLocked=true;}}closeAIDrawer(){if(!this.aiDrawerElement){return;}if(this.isDrawerFocusLocked){FocusLock.untrapFocus();this.aiDrawerElement.removeAttribute('aria-modal');this.aiDrawerElement.setAttribute('role','region');}this.aiDrawerElement.classList.remove('show');this.aiDrawerElement.setAttribute('tabindex',-1);if(this.aiDrawerBodyElement){this.aiDrawerBodyElement.removeAttribute('aria-live');}if(this.pageElement&&this.pageElement.classList.contains('show-drawer-right')){this.removePadding();}if(this.jumpToElement){this.jumpToElement.setAttribute('tabindex',-1);}if(this.actionElement){this.actionElement.classList.add('active');this.actionElement.focus();}}toggleAIDrawer(){if(this.isAIDrawerOpen()){this.closeAIDrawer();}else{this.openAIDrawer();}}addPadding(){if(this.pageElement&&this.aiDrawerBodyElement){this.pageElement.classList.add('show-drawer-right');this.aiDrawerBodyElement.dataset.removepadding='1';}}removePadding(){if(this.pageElement&&this.aiDrawerBodyElement){this.pageElement.classList.remove('show-drawer-right');this.aiDrawerBodyElement.dataset.removepadding='0';}}async generate(){if(!this.ollamaConfigured){Notification.alert('Ollama not configured','Please configure Ollama in plugin settings to generate questions.');return;}const text=this.textarea?.value?.trim();if(!text){Notification.alert('Error','Please enter text to generate questions');return;}const params={text:text,count:parseInt(this.countSelect?.value||5),type:this.typeSelect?.value||'multichoice',difficulty:this.difficultySelect?.value||'medium',language:this.languageSelect?.value||'ru',contextid:this.contextId};this.setLoading(true);this.questions=[];this.selectedQuestions.clear();try{const response=await Ajax.call([{methodname:'aiplacement_quizgen_generate',args:params}])[0];if(response.success){this.questions=JSON.parse(response.questions)||[];await this.renderQuestions();Str.get_string('success_generated','aiplacement_quizgen',this.questions.length).then(s=>Notification.addNotification({message:s,type:'success'}));}else{throw new Error(response.error||'Generation failed');}}catch(error){Notification.exception(error);if(this.questionsGrid){this.questionsGrid.innerHTML=`<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;}Notification.alert('Error',error.message);}finally{this.setLoading(false);}}async renderQuestions(){if(!this.questionsGrid||this.questions.length===0){this.questionsGrid.innerHTML=`<div class="alert alert-info">ü§ñ Press "Generate" to create questions</div>`;return;}const html=await Templates.render('aiplacement_quizgen/question_preview',{questions:this.questions,showSelect:true});this.questionsGrid.innerHTML=html;this.questions.forEach((q,index)=>{const card=this.questionsGrid.querySelector(`[data-question-index="${index}"]`);if(card){this.bindQuestionEvents(card,q,index);}});}bindQuestionEvents(card,question,index){const selectBtn=card.querySelector('.question-select');if(selectBtn){selectBtn.addEventListener('click',()=>{if(this.selectedQuestions.has(index)){this.selectedQuestions.delete(index);selectBtn.classList.remove('btn-primary');selectBtn.classList.add('btn-outline-primary');}else{this.selectedQuestions.add(index);selectBtn.classList.remove('btn-outline-primary');selectBtn.classList.add('btn-primary');}});}const regenBtn=card.querySelector('.question-regenerate');if(regenBtn){regenBtn.addEventListener('click',()=>this.regenerateQuestion(index));}const saveBtn=card.querySelector('.question-save');if(saveBtn){saveBtn.addEventListener('click',()=>this.saveQuestion(question));}const editBtn=card.querySelector('.question-edit');if(editBtn){editBtn.addEventListener('click',()=>this.editQuestion(question,card));}}async saveAll(){if(this.questions.length===0){return;}const questionsToSave=this.selectedQuestions.size>0?this.questions.filter((_,i)=>this.selectedQuestions.has(i)):this.questions;this.setSaving(true);try{const response=await Ajax.call([{methodname:'aiplacement_quizgen_save_to_bank',args:{questions:JSON.stringify(questionsToSave),courseid:this.courseId}}])[0];if(response.success){Str.get_string('success_saved','aiplacement_quizgen',response.saved_count).then(s=>Notification.addNotification({message:s,type:'success'}));this.selectedQuestions.clear();await this.renderQuestions();}}catch(error){Notification.exception(error);}finally{this.setSaving(false);}}async saveQuestion(question){try{const response=await Ajax.call([{methodname:'aiplacement_quizgen_save_to_bank',args:{questions:JSON.stringify([question]),courseid:this.courseId}}])[0];if(response.success){Notification.addNotification({message:'‚úÖ Question saved to bank',type:'success'});}}catch(error){Notification.exception(error);}}async regenerateQuestion(index){}editQuestion(question,card){}setLoading(loading){if(!this.generateBtn){return;}if(loading){this.generateBtn.disabled=true;this.generateBtn.innerHTML='<span class="quizgen-spinner"></span> Generating...';if(this.progressBar){this.progressBar.classList.add('active');}}else{this.generateBtn.disabled=!this.ollamaConfigured;this.generateBtn.innerHTML='üéØ Generate';if(this.progressBar){this.progressBar.classList.remove('active');}}}setSaving(saving){if(this.saveAllBtn){this.saveAllBtn.disabled=saving;this.saveAllBtn.innerHTML=saving?'üíæ Saving...':'üíæ Save all to bank';}}updateCharCount(){if(this.charCounter&&this.textarea){const len=this.textarea.value.length;this.charCounter.textContent=`${len} characters`;}}};return AIPQuizGen;});